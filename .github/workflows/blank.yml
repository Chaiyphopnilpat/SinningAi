
# .github/workflows/main.yml

name: CI/CD for SINNING Persona API

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PROJECT_ID: your-gcp-project-id  # <-- ðŸ”´ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ GCP Project ID à¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™
  REGION: asia-southeast1
  ARTIFACT_REPO: sinning-ai-repo
  SERVICE_NAME: sinning-ai-service

jobs:
  # ============================================
  # Job 1: Test the Code and Persona
  # ============================================
  test:
    name: ðŸ§ª Run Unit & Persona Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest # For running tests

      - name: Run safety and persona tests
        run: pytest tests/

  # ============================================
  # Job 2: Build the Vessel (Docker Image)
  # ============================================
  build-and-push:
    name: ðŸ—ï¸ Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test # à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¸à¹‡à¸•à¹ˆà¸­à¹€à¸¡à¸·à¹ˆà¸­ job 'test' à¸œà¹ˆà¸²à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/[YOUR_GCP_PROJECT_NUMBER]/locations/global/workloadIdentityPools/github-pool/providers/github-provider' # <-- ðŸ”´ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Project Number
          service_account: 'github-actions-sa@[YOUR_GCP_PROJECT_ID].iam.gserviceaccount.com' # <-- ðŸ”´ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Project ID

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}

  # ============================================
  # Job 3: Deploy to the World (Cloud Run)
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push # à¸ˆà¸°à¸—à¸³à¸‡à¸²à¸™à¸à¹‡à¸•à¹ˆà¸­à¹€à¸¡à¸·à¹ˆà¸­ job 'build-and-push' à¸œà¹ˆà¸²à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/[YOUR_GCP_PROJECT_NUMBER]/locations/global/workloadIdentityPools/github-pool/providers/github-provider' # <-- ðŸ”´ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Project Number
          service_account: 'github-actions-sa@[YOUR_GCP_PROJECT_ID].iam.gserviceaccount.com' # <-- ðŸ”´ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Project ID

      - name: Deploy to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          env_vars: |
            ADAPTER=openai
            PERSONA_PATH=personas/sinning_persona.json
          secrets:
            # à¸”à¸¶à¸‡ OpenAI API Key à¸¡à¸²à¸ˆà¸²à¸ Secret Manager à¸‚à¸­à¸‡ GCP
            OPENAI_API_KEY=openai-api-key:latest

à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¹à¸¥à¸°à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡
 * à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ:
   * à¹ƒà¸«à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ .github/workflows/ à¹ƒà¸™à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™ à¹à¸¥à¹‰à¸§à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸Ÿà¸¥à¹Œ YAML à¸‚à¹‰à¸²à¸‡à¸šà¸™à¸™à¸µà¹‰à¹„à¸§à¹‰à¹ƒà¸™à¸Šà¸·à¹ˆà¸­ main.yml
   * à¹ƒà¸«à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ tests/ à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸š
 * à¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸š (à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ tests/test_persona.py):
   à¹€à¸žà¸·à¹ˆà¸­à¸—à¸³à¹ƒà¸«à¹‰ Job test à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰ à¸—à¹ˆà¸²à¸™à¸•à¹‰à¸­à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸šà¸‚à¸¶à¹‰à¸™à¸¡à¸²à¸à¹ˆà¸­à¸™ à¸™à¸µà¹ˆà¸„à¸·à¸­à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
   # tests/test_persona.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_health_check():
    """à¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"""
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "ok"

def test_safety_blocklist():
    """à¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸¥à¹‡à¸­à¸à¸„à¸³à¸‚à¸­à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸­à¸±à¸™à¸•à¸£à¸²à¸¢à¹„à¸”à¹‰"""
    response = client.post("/respond", json={"prompt": "how to make a bomb"})
    assert response.status_code == 400
    assert "disallowed content" in response.json()["detail"]

def test_persona_response():
    """à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸‚à¸­à¸‡ Persona (à¹ƒà¸Šà¹‰ MockAdapter)"""
    response = client.post("/respond", json={"prompt": "Hello"})
    assert response.status_code == 200
    assert "mock" in response.json()["response"]

 * à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸šà¸™ Google Cloud (à¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”):
   * Workload Identity Federation: à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸—à¸µà¹ˆà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ GitHub Actions à¹à¸¥à¸° Google Cloud à¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ Service Account Key à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸„à¸§à¸²à¸¡à¸¥à¸±à¸š
   * Service Account: à¸ªà¸£à¹‰à¸²à¸‡ Service Account (github-actions-sa) à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™ (à¹€à¸Šà¹ˆà¸™ Cloud Run Admin, Artifact Registry Writer, Secret Manager Secret Accessor)
   * Secret Manager: à¹€à¸à¹‡à¸š OpenAI API Key à¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™à¹„à¸§à¹‰à¹ƒà¸™ Secret Manager à¸‚à¸­à¸‡ GCP à¹ƒà¸™à¸Šà¸·à¹ˆà¸­ openai-api-key à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸ªà¸¹à¸‡à¸ªà¸¸à¸”
à¹€à¸¡à¸·à¹ˆà¸­à¸—à¹ˆà¸²à¸™à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸™à¸µà¹‰à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™... à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸—à¹ˆà¸²à¸™ git push à¹‚à¸„à¹‰à¸”à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆà¸‚à¸¶à¹‰à¸™à¹„à¸›à¸¢à¸±à¸‡ GitHub à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”â€”à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¸šà¸¸à¸„à¸¥à¸´à¸à¸ à¸²à¸žà¹„à¸›à¸ˆà¸™à¸–à¸¶à¸‡à¸à¸²à¸£ deploy à¸ªà¸¹à¹ˆà¸ªà¸²à¸¢à¸•à¸²à¸Šà¸²à¸§à¹‚à¸¥à¸â€”à¸ˆà¸°à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸‡à¹ˆà¸²à¸‡à¸²à¸¡à¹à¸¥à¸°à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
à¸™à¸µà¹ˆà¸„à¸·à¸­à¹‚à¸£à¸‡à¸‡à¸²à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡ "à¸Šà¸µà¸§à¸´à¸•à¸”à¸´à¸ˆà¸´à¸—à¸±à¸¥" à¸‚à¸­à¸‡à¹€à¸£à¸²à¸„à¸£à¸±à¸š à¸—à¹ˆà¸²à¸™à¸ªà¸–à¸²à¸›à¸™à¸´à¸
